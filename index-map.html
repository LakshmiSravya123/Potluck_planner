<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">Potluck Map - Plan Your Event</title>
    <meta property="og:title" content="Potluck Map - Plan Your Event">
    <meta property="og:description" content="Interactive map-based potluck planner">
    <meta property="og:image" content="">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>tailwind.config={darkMode:'class',theme:{extend:{fontFamily:{sans:['Inter','sans-serif']}}}}</script>
    
    <!-- Leaflet Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Marker Cluster -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    
    <!-- LocalForage for caching -->
    <script src="https://unpkg.com/localforage@1.10.0/dist/localforage.min.js"></script>
    
    <!-- html2canvas for screenshots -->
    <script src="https://unpkg.com/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    
    <style>
        .glassmorphism { background: rgba(255,255,255,0.7); backdrop-filter: blur(10px); }
        .dark .glassmorphism { background: rgba(31,41,55,0.7); }
        #map { height: 400px; z-index: 1; }
        .leaflet-popup-content-wrapper { border-radius: 12px; }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 font-sans transition-colors">
    
    <!-- Header -->
    <header class="glassmorphism border-b border-gray-200 dark:border-gray-700 sticky top-0 z-50">
        <div class="max-w-6xl mx-auto px-4 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-slate-800 dark:text-white">üó∫Ô∏è Potluck Map</h1>
            <div class="flex gap-2">
                <button id="darkModeBtn" class="p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors" title="Toggle dark mode">
                    üåô
                </button>
                <button id="shareBtn" class="px-4 py-2 bg-emerald-600 text-white rounded-lg font-medium hover:bg-emerald-700 transition-colors">
                    üì§ Share
                </button>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <main class="max-w-6xl mx-auto px-4 py-6">
        
        <!-- MAP: Live pins here -->
        <div class="glassmorphism rounded-2xl shadow-lg p-4 mb-6 relative">
            <div class="flex justify-between items-center mb-3">
                <h2 class="text-lg font-semibold text-slate-800 dark:text-white">üìç Event Map</h2>
                <div class="flex gap-2">
                    <button id="locateMeBtn" class="p-2 bg-white dark:bg-gray-800 rounded-lg shadow hover:shadow-md transition-all" title="Locate me">
                        üéØ
                    </button>
                    <input id="searchMap" type="text" placeholder="Search location..." class="px-3 py-1 text-sm border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 dark:bg-gray-800 dark:text-white">
                </div>
            </div>
            <div id="map" class="rounded-2xl shadow-inner"></div>
            <div id="mapStats" class="mt-2 text-sm text-gray-600 dark:text-gray-400 text-center">0 guests pinned</div>
        </div>

        <!-- Tabs -->
        <div class="flex gap-6 border-b border-gray-200 dark:border-gray-700 mb-6">
            <button id="guestsTab" class="pb-3 font-semibold text-emerald-600 border-b-2 border-emerald-600 transition-colors">Guests</button>
            <button id="itemsTab" class="pb-3 font-semibold text-slate-600 dark:text-gray-400 hover:text-slate-800 dark:hover:text-white transition-colors">Items</button>
        </div>

        <!-- Guests Section -->
        <div id="guestsSection">
            <div class="glassmorphism rounded-xl shadow-md p-6 mb-6">
                <h2 class="text-lg font-semibold text-slate-800 dark:text-white mb-4">Add Guest</h2>
                <form id="guestForm" class="grid grid-cols-1 md:grid-cols-3 gap-3">
                    <input type="text" id="guestName" placeholder="Name" required class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 dark:bg-gray-800 dark:text-white">
                    <input type="email" id="guestEmail" placeholder="Email (optional)" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 dark:bg-gray-800 dark:text-white">
                    <input type="text" id="guestAddress" placeholder="Address" required class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 dark:bg-gray-800 dark:text-white">
                    <button type="submit" class="md:col-span-3 px-6 py-2 bg-emerald-600 text-white rounded-lg font-medium hover:bg-emerald-700 transition-colors">üìç Add & Pin</button>
                </form>
            </div>

            <div class="glassmorphism rounded-xl shadow-md p-6">
                <h2 class="text-lg font-semibold text-slate-800 dark:text-white mb-4">Guest List</h2>
                <div class="space-y-2" id="guestList"></div>
                <div id="noGuests" class="text-center py-8 text-gray-400">No guests yet</div>
            </div>
        </div>

        <!-- Items Section -->
        <div id="itemsSection" class="hidden">
            <div class="glassmorphism rounded-xl shadow-md p-6 mb-6">
                <h2 class="text-lg font-semibold text-slate-800 dark:text-white mb-4">Add Item</h2>
                <form id="itemForm" class="flex gap-3">
                    <input type="text" id="itemName" placeholder="Dish or item..." required class="flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 dark:bg-gray-800 dark:text-white">
                    <button type="submit" class="px-6 py-2 bg-emerald-600 text-white rounded-lg font-medium hover:bg-emerald-700 transition-colors">Add</button>
                </form>
            </div>

            <div class="glassmorphism rounded-xl shadow-md p-6">
                <h2 class="text-lg font-semibold text-slate-800 dark:text-white mb-4">Items List</h2>
                <div id="itemList" class="space-y-2"></div>
                <div id="noItems" class="text-center py-8 text-gray-400">No items yet</div>
            </div>
        </div>
    </main>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-4 right-4 bg-emerald-500 text-white px-6 py-3 rounded-lg shadow-lg hidden transition-all transform">
        <span id="toastMsg">Saved!</span>
    </div>

    <!-- Confetti Canvas -->
    <canvas id="confetti" class="fixed inset-0 pointer-events-none z-50"></canvas>

    <script>
    // MAP: Live pins here
    const app = {
        eventId: '',
        guests: [],
        items: [],
        map: null,
        markers: L.markerClusterGroup(),
        geocodeCache: {},
        saveTimer: null,
        darkMode: false,
        
        // Custom emerald potluck pin icon (SVG data URI)
        pinIcon: L.icon({
            iconUrl: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iNDgiIHZpZXdCb3g9IjAgMCAzMiA0OCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMTYgNDhDMTYgNDggMzIgMjggMzIgMTZDMzIgNy4xNjM0NCAyNC44MzY2IDAgMTYgMEM3LjE2MzQ0IDAgMCA3LjE2MzQ0IDAgMTZDMCAyOCAxNiA0OCAxNiA0OFoiIGZpbGw9IiMxMGI5ODEiLz48Y2lyY2xlIGN4PSIxNiIgY3k9IjE2IiByPSI4IiBmaWxsPSJ3aGl0ZSIvPjx0ZXh0IHg9IjE2IiB5PSIyMCIgZm9udC1zaXplPSIxMiIgdGV4dC1hbmNob3I9Im1pZGRsZSI+8J+NvTwvdGV4dD48L3N2Zz4=',
            iconSize: [32, 48],
            iconAnchor: [16, 48],
            popupAnchor: [0, -48]
        }),
        
        async init() {
            // Parse URL: ?event=ID#map=zoom,lat,lng
            const params = new URLSearchParams(location.search);
            this.eventId = params.get('event') || this.generateId();
            if (!params.get('event')) {
                history.replaceState(null, '', `?event=${this.eventId}`);
            }
            
            await this.loadCache();
            await this.loadData();
            this.initMap();
            this.bindEvents();
            this.render();
            this.updateTitle();
        },
        
        generateId() {
            return Math.random().toString(36).substr(2, 8);
        },
        
        initMap() {
            // Initialize map
            this.map = L.map('map').setView([37.7749, -122.4194], 10); // Default: SF
            
            // Tile layer (switches for dark mode)
            this.updateMapTiles();
            
            // Add marker cluster
            this.map.addLayer(this.markers);
            
            // Parse hash for map position
            const hash = location.hash.slice(1);
            if (hash.startsWith('map=')) {
                const [zoom, lat, lng] = hash.slice(4).split(',').map(Number);
                if (lat && lng) this.map.flyTo([lat, lng], zoom);
            }
            
            // Update hash on map move
            this.map.on('moveend', () => {
                const center = this.map.getCenter();
                const zoom = this.map.getZoom();
                history.replaceState(null, '', `?event=${this.eventId}#map=${zoom},${center.lat.toFixed(4)},${center.lng.toFixed(4)}`);
            });
        },
        
        updateMapTiles() {
            if (this.tileLayer) this.map.removeLayer(this.tileLayer);
            const tileUrl = this.darkMode 
                ? 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png'
                : 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
            this.tileLayer = L.tileLayer(tileUrl, {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(this.map);
        },
        
        bindEvents() {
            // Dark mode
            darkModeBtn.onclick = () => {
                this.darkMode = !this.darkMode;
                document.documentElement.classList.toggle('dark', this.darkMode);
                this.updateMapTiles();
                darkModeBtn.textContent = this.darkMode ? '‚òÄÔ∏è' : 'üåô';
            };
            
            // Tabs
            guestsTab.onclick = () => this.switchTab('guests');
            itemsTab.onclick = () => this.switchTab('items');
            
            // Locate me
            locateMeBtn.onclick = () => {
                navigator.geolocation.getCurrentPosition(pos => {
                    this.map.flyTo([pos.coords.latitude, pos.coords.longitude], 13);
                    this.showToast('Located! üéØ');
                });
            };
            
            // Search map
            let searchTimeout;
            searchMap.oninput = (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => this.searchLocation(e.target.value), 300);
            };
            
            // Share with screenshot
            shareBtn.onclick = async () => {
                await this.shareEvent();
            };
            
            // Forms
            guestForm.onsubmit = async (e) => {
                e.preventDefault();
                await this.addGuest(guestName.value, guestEmail.value, guestAddress.value);
                guestForm.reset();
            };
            
            itemForm.onsubmit = (e) => {
                e.preventDefault();
                this.addItem(itemName.value);
                itemForm.reset();
            };
        },
        
        async searchLocation(query) {
            if (!query.trim()) return;
            const coords = await this.geocode(query);
            if (coords) {
                this.map.flyTo(coords, 13);
                this.showToast('Found! üìç');
            }
        },
        
        // Geocode with caching (debounced 300ms)
        async geocode(address) {
            if (this.geocodeCache[address]) return this.geocodeCache[address];
            
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`);
                const data = await res.json();
                if (data[0]) {
                    const coords = [parseFloat(data[0].lat), parseFloat(data[0].lon)];
                    this.geocodeCache[address] = coords;
                    await localforage.setItem(`geocode_${address}`, coords);
                    return coords;
                }
            } catch (e) {
                console.error('Geocode error:', e);
            }
            return null;
        },
        
        async addGuest(name, email, address) {
            const coords = await this.geocode(address);
            if (!coords) {
                this.showToast('Address not found ‚ùå');
                return;
            }
            
            const guest = { name, email, address, coords, rsvp: false };
            this.guests.push(guest);
            
            // Drop emerald pin with confetti
            const marker = L.marker(coords, { icon: this.pinIcon })
                .bindPopup(`<b>${name}</b><br>${address}`)
                .addTo(this.markers);
            
            this.confetti();
            this.showToast(`Pinned! üö© ${name}`);
            this.map.flyTo(coords, 13);
            
            this.render();
            this.scheduleSave();
            this.updateTitle();
        },
        
        deleteGuest(idx) {
            this.guests.splice(idx, 1);
            this.markers.clearLayers();
            this.guests.forEach(g => {
                if (g.coords) {
                    L.marker(g.coords, { icon: this.pinIcon })
                        .bindPopup(`<b>${g.name}</b><br>${g.address}`)
                        .addTo(this.markers);
                }
            });
            this.render();
            this.scheduleSave();
            this.updateTitle();
        },
        
        toggleRSVP(idx) {
            this.guests[idx].rsvp = !this.guests[idx].rsvp;
            this.render();
            this.scheduleSave();
        },
        
        addItem(name) {
            this.items.push({ name, assignee: '', done: false });
            this.render();
            this.scheduleSave();
        },
        
        deleteItem(idx) {
            this.items.splice(idx, 1);
            this.render();
            this.scheduleSave();
        },
        
        toggleDone(idx) {
            this.items[idx].done = !this.items[idx].done;
            this.render();
            this.scheduleSave();
        },
        
        assignItem(idx, assignee) {
            this.items[idx].assignee = assignee;
            this.scheduleSave();
        },
        
        switchTab(tab) {
            if (tab === 'guests') {
                guestsSection.classList.remove('hidden');
                itemsSection.classList.add('hidden');
                guestsTab.className = 'pb-3 font-semibold text-emerald-600 border-b-2 border-emerald-600 transition-colors';
                itemsTab.className = 'pb-3 font-semibold text-slate-600 dark:text-gray-400 hover:text-slate-800 dark:hover:text-white transition-colors';
            } else {
                guestsSection.classList.add('hidden');
                itemsSection.classList.remove('hidden');
                itemsTab.className = 'pb-3 font-semibold text-emerald-600 border-b-2 border-emerald-600 transition-colors';
                guestsTab.className = 'pb-3 font-semibold text-slate-600 dark:text-gray-400 hover:text-slate-800 dark:hover:text-white transition-colors';
            }
        },
        
        render() {
            // Guests
            noGuests.style.display = this.guests.length ? 'none' : 'block';
            guestList.innerHTML = this.guests.map((g, i) => `
                <div class="flex items-center gap-3 p-4 bg-white dark:bg-gray-800 rounded-lg shadow-sm hover:shadow-md transition-shadow">
                    <div class="flex-1">
                        <div class="font-semibold text-slate-800 dark:text-white">${g.name}</div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">üìç ${g.address}</div>
                    </div>
                    <button onclick="app.toggleRSVP(${i})" class="w-11 h-6 rounded-full transition-colors ${g.rsvp ? 'bg-emerald-500' : 'bg-gray-300 dark:bg-gray-600'}">
                        <span class="block w-4 h-4 bg-white rounded-full transition-transform ${g.rsvp ? 'ml-6' : 'ml-1'}"></span>
                    </button>
                    <button onclick="app.deleteGuest(${i})" class="text-red-500 hover:text-red-700 p-2">üóëÔ∏è</button>
                </div>
            `).join('');
            
            // Items
            noItems.style.display = this.items.length ? 'none' : 'block';
            itemList.innerHTML = this.items.map((item, i) => `
                <div class="flex items-center gap-3 p-3 bg-white dark:bg-gray-800 rounded-lg shadow-sm">
                    <input type="checkbox" ${item.done ? 'checked' : ''} onchange="app.toggleDone(${i})" class="w-5 h-5 text-emerald-600 rounded">
                    <span class="flex-1 ${item.done ? 'line-through text-gray-400' : 'text-slate-800 dark:text-white'}">${item.name}</span>
                    <select onchange="app.assignItem(${i}, this.value)" class="px-3 py-1 border border-gray-300 dark:border-gray-600 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500 dark:bg-gray-700 dark:text-white">
                        <option value="">Assign...</option>
                        ${this.guests.map(g => `<option value="${g.name}" ${item.assignee === g.name ? 'selected' : ''}>${g.name}</option>`).join('')}
                    </select>
                    <button onclick="app.deleteItem(${i})" class="text-red-500 hover:text-red-700">‚úï</button>
                </div>
            `).join('');
            
            // Map stats
            mapStats.textContent = `${this.guests.length} guest${this.guests.length !== 1 ? 's' : ''} pinned`;
        },
        
        updateTitle() {
            const title = `Potluck Map - #${this.eventId} | ${this.guests.length} Guests Pinned!`;
            document.title = title;
            pageTitle.textContent = title;
        },
        
        async shareEvent() {
            this.showToast('Generating share link...');
            
            // Capture map screenshot
            const canvas = await html2canvas(document.getElementById('map'));
            const imgData = canvas.toDataURL();
            
            // Update OG image meta
            document.querySelector('meta[property="og:image"]').content = imgData;
            
            // Copy URL
            await navigator.clipboard.writeText(location.href);
            this.showToast('Link copied! üì§');
        },
        
        // Confetti animation
        confetti() {
            const canvas = document.getElementById('confetti');
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            
            const particles = Array.from({ length: 50 }, () => ({
                x: Math.random() * canvas.width,
                y: -10,
                vx: (Math.random() - 0.5) * 4,
                vy: Math.random() * 3 + 2,
                color: ['#10b981', '#3b82f6', '#f59e0b', '#ec4899'][Math.floor(Math.random() * 4)]
            }));
            
            const animate = () => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                particles.forEach(p => {
                    p.x += p.vx;
                    p.y += p.vy;
                    ctx.fillStyle = p.color;
                    ctx.fillRect(p.x, p.y, 8, 8);
                });
                if (particles[0].y < canvas.height) requestAnimationFrame(animate);
            };
            animate();
        },
        
        showToast(msg) {
            toastMsg.textContent = msg;
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 2000);
        },
        
        // Batched saves with requestAnimationFrame
        scheduleSave() {
            if (this.saveTimer) return;
            this.saveTimer = requestAnimationFrame(async () => {
                await localforage.setItem(`event_${this.eventId}`, {
                    guests: this.guests,
                    items: this.items
                });
                this.saveTimer = null;
            });
        },
        
        async loadData() {
            const data = await localforage.getItem(`event_${this.eventId}`);
            if (data) {
                this.guests = data.guests || [];
                this.items = data.items || [];
                
                // Re-add markers
                this.guests.forEach(g => {
                    if (g.coords) {
                        L.marker(g.coords, { icon: this.pinIcon })
                            .bindPopup(`<b>${g.name}</b><br>${g.address}`)
                            .addTo(this.markers);
                    }
                });
                
                // Auto-center on pins
                if (this.guests.length > 0) {
                    const bounds = L.latLngBounds(this.guests.map(g => g.coords).filter(Boolean));
                    this.map.fitBounds(bounds, { padding: [50, 50] });
                }
            }
        },
        
        async loadCache() {
            // Load geocode cache from localForage
            const keys = await localforage.keys();
            for (const key of keys.filter(k => k.startsWith('geocode_'))) {
                const address = key.slice(8);
                this.geocodeCache[address] = await localforage.getItem(key);
            }
        }
    };
    
    // Init on load
    window.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>
