<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Plan your 2025 Thanksgiving potluck easily with real-time collaboration, dark mode, and offline support. Track guests, dishes, servings, and dietary info.">
    <meta name="keywords" content="Thanksgiving, potluck planner, 2025, meal planning, party organizer, collaborative planning">
    <meta name="author" content="Potluck Planner">
    <title>ğŸ¦ƒ Thanksgiving Potluck 2025 - Plan Your Perfect Feast</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class'
        }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        body { background: linear-gradient(135deg, #fbbf24 0%, #ec4899 100%); font-family: 'Inter', sans-serif; transition: background 0.3s ease; }
        body.dark { background: linear-gradient(135deg, #1f2937 0%, #111827 100%); }
        .category-appetizers { background: #dbeafe; color: #1e40af; }
        .category-mains { background: #fecaca; color: #991b1b; }
        .category-sides { background: #bbf7d0; color: #166534; }
        .category-desserts { background: #fef3c7; color: #92400e; }
        .category-drinks { background: #ddd6fe; color: #5b21b6; }
        .category-other { background: #e5e7eb; color: #374151; }
        .editable { cursor: pointer; padding: 4px 8px; border-radius: 4px; transition: all 0.2s; }
        .editable:hover { background: rgba(251, 191, 36, 0.1); }
        .editable:hover::after { content: 'âœï¸'; position: absolute; margin-left: 8px; font-size: 12px; opacity: 0.6; }
        .tooltip { position: relative; cursor: help; }
        .tooltip .tooltiptext { visibility: hidden; width: 220px; background-color: #1f2937; color: #fff; text-align: left; border-radius: 8px; padding: 10px 12px; position: absolute; z-index: 1000; bottom: 125%; left: 50%; margin-left: -110px; opacity: 0; transition: opacity 0.3s; font-size: 13px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }
        @media print {
            .no-print { display: none !important; }
            body { background: white !important; }
            .bg-white\/90 { background: white !important; }
            table { page-break-inside: avoid; }
            tr { page-break-inside: avoid; }
            .print-header { display: block !important; }
        }
    </style>
</head>
<body class="min-h-screen p-8 dark:bg-gray-900 transition-colors duration-300">
    <div class="max-w-6xl mx-auto">
        <!-- Print Header (hidden on screen) -->
        <div class="print-header hidden text-center mb-4">
            <h1 class="text-3xl font-bold text-gray-900">ğŸ¦ƒ Thanksgiving Potluck 2025 ğŸ‚</h1>
            <p class="text-sm text-gray-600 mt-2">Generated on <span id="printDate"></span></p>
        </div>
        
        <div class="text-center mb-8 no-print">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-2">
                    <span id="liveIndicator" class="hidden px-3 py-1 bg-green-500/20 dark:bg-green-500/30 border border-green-500 rounded-full text-xs font-semibold text-green-700 dark:text-green-300 cursor-help" title="This list updates in real-time when shared">
                        ğŸŸ¢ Live
                    </span>
                    <button onclick="toggleViewMode()" id="viewModeBtn" class="hidden px-3 py-1 bg-amber-500/20 dark:bg-amber-500/30 border border-amber-500 rounded-full text-xs font-semibold text-amber-700 dark:text-amber-300">
                        âœï¸ Edit Mode
                    </button>
                </div>
                <h1 class="text-5xl font-bold text-white dark:text-gray-100 mb-0">ğŸ¦ƒ Thanksgiving Potluck 2025 ğŸ‚</h1>
                <button onclick="toggleDarkMode()" id="darkModeBtn" class="px-4 py-2 bg-white/90 dark:bg-gray-800 rounded-xl shadow-lg transition-colors">
                    <span id="darkModeIcon">ğŸŒ™</span>
                </button>
            </div>
            <div class="flex items-center justify-center gap-3 flex-wrap">
                <button onclick="showShortcuts()" class="px-4 py-2 bg-white/90 dark:bg-gray-800 dark:text-gray-100 rounded-xl shadow-lg">âŒ¨ï¸ Shortcuts (?)</button>
                <button onclick="shareLink()" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-xl shadow-lg transition-colors">ğŸ“‹ Share Link (Live)</button>
                <button onclick="createNewEvent()" class="px-4 py-2 bg-purple-500 hover:bg-purple-600 text-white rounded-xl shadow-lg transition-colors">â• New Event</button>
                <button onclick="saveOfflineCopy()" class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-xl shadow-lg transition-colors" title="Save a backup copy to your device">ğŸ’¾ Save Offline</button>
            </div>
        </div>
        <!-- Welcome Message -->
        <div class="mb-6 bg-gradient-to-r from-orange-50 to-amber-50 dark:from-orange-900/20 dark:to-amber-900/20 border-2 border-orange-300 dark:border-orange-700 rounded-2xl p-6 shadow-lg">
            <div class="flex items-start gap-4">
                <span class="text-4xl">ğŸƒ</span>
                <div>
                    <h2 class="text-2xl font-bold text-orange-900 dark:text-orange-200 mb-2">ğŸ‰ Welcome to Your Thanksgiving Potluck Planner!</h2>
                    <p class="text-orange-800 dark:text-orange-300 text-sm mb-3">Organize your perfect Thanksgiving feast with ease. Here's how to get started:</p>
                    <ul class="text-orange-700 dark:text-orange-300 text-sm space-y-1 list-disc list-inside">
                        <li><strong>Add guests:</strong> Click "â• Add Guest" or press <kbd class="px-2 py-0.5 bg-orange-200 dark:bg-orange-800 rounded text-xs">Ctrl+N</kbd></li>
                        <li><strong>Real-time collaboration:</strong> Click "ğŸ“‹ Share Link (Live)" to invite others to edit</li>
                        <li><strong>Offline backup:</strong> Click "ğŸ’¾ Save Offline" to work without internet</li>
                        <li><strong>Search & filter:</strong> Use the search bar to find specific guests or dishes</li>
                        <li><strong>Dark mode:</strong> Toggle ğŸŒ™/â˜€ï¸ in the top-right corner</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <div class="grid grid-cols-3 gap-4 mb-6">
            <div class="bg-white/90 dark:bg-gray-800/90 rounded-xl p-4 shadow-lg"><div class="text-3xl">ğŸ‘¥</div><div class="text-2xl font-bold dark:text-white" id="totalGuests">0</div><div class="text-sm text-gray-600 dark:text-gray-400">Total Guests</div></div>
            <div class="bg-white/90 dark:bg-gray-800/90 rounded-xl p-4 shadow-lg"><div class="text-3xl">ğŸ½ï¸</div><div class="text-2xl font-bold dark:text-white" id="totalDishes">0</div><div class="text-sm text-gray-600 dark:text-gray-400">Total Dishes</div></div>
            <div class="bg-white/90 dark:bg-gray-800/90 rounded-xl p-4 shadow-lg"><div class="text-sm font-semibold mb-2 dark:text-gray-200">ğŸ“Š Categories</div><div id="categoryBreakdown" class="text-xs text-gray-600 dark:text-gray-400">-</div></div>
        </div>
        <!-- Info Banner -->
        <div id="infoBanner" class="hidden mb-6 bg-blue-50 dark:bg-blue-900/20 border-2 border-blue-300 dark:border-blue-700 rounded-xl p-4">
            <div class="flex items-start gap-3">
                <span class="text-2xl">ğŸ’¡</span>
                <div class="flex-1">
                    <h4 class="font-bold text-blue-900 dark:text-blue-200 text-sm">Offline Mode</h4>
                    <p class="text-blue-800 dark:text-blue-300 text-xs mt-1">You're working offline. Click "Share Link (Live)" to enable real-time collaboration!</p>
                </div>
                <button onclick="document.getElementById('infoBanner').classList.add('hidden')" class="text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-200">âœ•</button>
            </div>
        </div>
        <!-- Missing Categories Alert -->
        <div id="missingAlert" class="hidden mb-6 bg-amber-50 dark:bg-amber-900/20 border-2 border-amber-300 dark:border-amber-700 rounded-xl p-4">
            <div class="flex items-start gap-3">
                <span class="text-2xl">âš ï¸</span>
                <div>
                    <h4 class="font-bold text-amber-900 dark:text-amber-200 text-sm">Missing Categories</h4>
                    <p id="missingText" class="text-amber-800 dark:text-amber-300 text-xs mt-1"></p>
                </div>
            </div>
        </div>
        <div class="mb-6 no-print">
            <div class="relative">
                <input type="text" id="searchInput" placeholder="ğŸ” Search guests or dishes..." onkeyup="filterGuests()" class="w-full px-6 py-4 rounded-2xl bg-white/90 dark:bg-gray-800 dark:text-white dark:border-gray-600 border-2 border-amber-200 focus:border-amber-400 focus:outline-none text-lg">
                <button onclick="clearSearch()" id="clearBtn" class="hidden absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 dark:text-gray-500">âœ•</button>
            </div>
            <p id="searchResults" class="text-sm text-white dark:text-gray-300 mt-2 hidden"></p>
        </div>
        <div class="flex gap-3 mb-6 no-print">
            <button onclick="showAddModal()" class="px-6 py-3 bg-amber-500 hover:bg-amber-600 text-white font-bold rounded-xl shadow-lg transition-colors">â• Add Guest</button>
            <button onclick="exportCSV()" class="px-6 py-3 bg-white/90 dark:bg-gray-800 dark:text-gray-100 hover:bg-white dark:hover:bg-gray-700 rounded-xl shadow-lg transition-colors">ğŸ“¥ Export CSV</button>
            <button onclick="window.print()" class="px-6 py-3 bg-white/90 dark:bg-gray-800 dark:text-gray-100 hover:bg-white dark:hover:bg-gray-700 rounded-xl shadow-lg transition-colors">ğŸ–¨ï¸ Print</button>
            <button onclick="showQR()" class="px-6 py-3 bg-white/90 dark:bg-gray-800 dark:text-gray-100 hover:bg-white dark:hover:bg-gray-700 rounded-xl shadow-lg transition-colors">ğŸ“± QR Code</button>
        </div>
        <div class="bg-white/90 dark:bg-gray-800/90 rounded-2xl shadow-xl overflow-hidden">
            <table class="w-full">
                <thead class="bg-gray-50 dark:bg-gray-700">
                    <tr>
                        <th class="px-4 py-3 text-left text-sm font-semibold dark:text-gray-200">Avatar</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold dark:text-gray-200 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600" onclick="sortTable('name')" title="Click to sort">
                            Name <span class="text-xs">â†•ï¸</span>
                        </th>
                        <th class="px-4 py-3 text-left text-sm font-semibold dark:text-gray-200 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600" onclick="sortTable('dish')" title="Click to sort">
                            Dish <span class="text-xs">â†•ï¸</span>
                        </th>
                        <th class="px-4 py-3 text-left text-sm font-semibold dark:text-gray-200 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600" onclick="sortTable('category')" title="Click to sort">
                            Category <span class="text-xs">â†•ï¸</span>
                        </th>
                        <th class="px-4 py-3 text-left text-sm font-semibold dark:text-gray-200 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600" onclick="sortTable('serves')" title="Click to sort">
                            Serves <span class="text-xs">â†•ï¸</span>
                        </th>
                        <th class="px-4 py-3 text-left text-sm font-semibold dark:text-gray-200">Notes</th>
                        <th class="px-4 py-3 text-right text-sm font-semibold dark:text-gray-200">Actions</th>
                    </tr>
                </thead>
                <tbody id="guestsList"></tbody>
            </table>
            <div id="emptyState" class="text-center py-12 hidden"><div class="text-6xl">ğŸ‚</div><p class="text-xl mt-4 dark:text-gray-300">No guests yet</p></div>
        </div>
        <!-- Total Servings Display -->
        <div id="totalServingsDisplay" class="hidden mt-4 bg-gradient-to-r from-green-50 to-emerald-50 dark:from-green-900/20 dark:to-emerald-900/20 border-2 border-green-300 dark:border-green-700 rounded-xl p-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <span class="text-3xl">ğŸ½ï¸</span>
                    <div>
                        <h3 class="font-bold text-green-900 dark:text-green-200 text-lg">Total Servings</h3>
                        <p class="text-green-700 dark:text-green-300 text-sm">Estimated people served</p>
                    </div>
                </div>
                <div class="text-4xl font-bold text-green-900 dark:text-green-200" id="totalServings">0</div>
            </div>
        </div>
    </div>
    <div id="addModal" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center p-4 z-50">
        <div class="bg-white dark:bg-gray-800 rounded-3xl p-8 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <h2 class="text-3xl font-bold mb-6 dark:text-white" id="modalTitle">Add Guest</h2>
            <form onsubmit="saveGuest(event)" class="space-y-4">
                <input type="hidden" id="guestId">
                <div><label class="block font-bold mb-2 dark:text-gray-200">Name *</label><input type="text" id="guestName" required class="w-full px-4 py-3 border-2 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-xl focus:border-amber-400"></div>
                <div><label class="block font-bold mb-2 dark:text-gray-200">Dish *</label><input type="text" id="guestDish" required list="dishes" class="w-full px-4 py-3 border-2 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-xl focus:border-amber-400"><datalist id="dishes"><option value="ğŸ¦ƒ Turkey"><option value="ğŸ¥” Mashed Potatoes"><option value="ğŸ¥§ Pumpkin Pie"><option value="ğŸ· Wine"></datalist></div>
                <div><label class="block font-bold mb-2 dark:text-gray-200">Category *</label><select id="guestCategory" required class="w-full px-4 py-3 border-2 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-xl focus:border-amber-400"><option value="">Select...</option><option value="appetizers">ğŸ¥– Appetizers</option><option value="mains">ğŸ— Main Courses</option><option value="sides">ğŸ¥— Side Dishes</option><option value="desserts">ğŸ¥§ Desserts</option><option value="drinks">ğŸ· Drinks</option><option value="other">ğŸ´ Other</option></select></div>
                <div><label class="block font-bold mb-2 dark:text-gray-200">Serves (people)</label><input type="number" id="guestServes" min="1" class="w-full px-4 py-3 border-2 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-xl focus:border-amber-400" placeholder="Optional"></div>
                <div><label class="block font-bold mb-2 dark:text-gray-200">Notes / Dietary Info</label><textarea id="guestNotes" rows="3" class="w-full px-4 py-3 border-2 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-xl focus:border-amber-400" placeholder="Vegetarian, gluten-free, etc."></textarea></div>
                <div class="flex gap-4"><button type="submit" class="flex-1 px-6 py-4 bg-amber-500 hover:bg-amber-600 text-white font-bold rounded-xl">Save</button><button type="button" onclick="hideModal()" class="px-6 py-4 bg-gray-200 dark:bg-gray-700 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-xl">Cancel</button></div>
            </form>
        </div>
    </div>
    <div id="qrModal" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center p-4 z-50">
        <div class="bg-white dark:bg-gray-800 rounded-3xl p-8 max-w-md w-full">
            <h3 class="text-2xl font-bold mb-6 text-center dark:text-white">Share Party ğŸ“±</h3>
            <div id="qrcode" class="flex justify-center mb-6"></div>
            <div class="flex gap-3"><button onclick="downloadQR()" class="flex-1 px-6 py-3 bg-amber-500 hover:bg-amber-600 text-white font-bold rounded-xl">ğŸ“¥ Download</button><button onclick="hideQR()" class="px-6 py-3 bg-gray-200 dark:bg-gray-700 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-xl">Close</button></div>
        </div>
    </div>
    <div id="shortcutsModal" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center p-4 z-50">
        <div class="bg-white dark:bg-gray-800 rounded-3xl p-8 max-w-lg w-full">
            <h3 class="text-2xl font-bold mb-6 dark:text-white">âŒ¨ï¸ Keyboard Shortcuts</h3>
            <div class="space-y-3">
                <div class="flex justify-between py-2 border-b dark:border-gray-700"><span class="dark:text-gray-200">Add Guest</span><kbd class="px-3 py-1 bg-gray-100 dark:bg-gray-700 dark:text-gray-200 rounded font-mono">Ctrl/âŒ˜ + N</kbd></div>
                <div class="flex justify-between py-2 border-b dark:border-gray-700"><span class="dark:text-gray-200">Close Modal</span><kbd class="px-3 py-1 bg-gray-100 dark:bg-gray-700 dark:text-gray-200 rounded font-mono">Escape</kbd></div>
                <div class="flex justify-between py-2"><span class="dark:text-gray-200">Show Shortcuts</span><kbd class="px-3 py-1 bg-gray-100 dark:bg-gray-700 dark:text-gray-200 rounded font-mono">?</kbd></div>
            </div>
            <button onclick="hideShortcuts()" class="w-full mt-6 px-6 py-3 bg-gray-200 dark:bg-gray-700 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-xl">Got it!</button>
        </div>
    </div>
    <div id="toastContainer" class="fixed top-4 right-4 z-50"></div>
    <script>
        /*
         * THANKSGIVING POTLUCK PLANNER 2025
         * Enhanced Version - Changelog
         * 
         * FEATURES IMPLEMENTED:
         * âœ… Interactive guest/dish management with modal forms
         * âœ… Real-time data persistence using localStorage
         * âœ… URL hash-based sharing for multi-user collaboration
         * âœ… Auto-sync every 2 seconds for real-time updates
         * âœ… Edit/Delete functionality with confirmation prompts
         * âœ… Dynamic category tracking and breakdown display
         * âœ… Dark mode toggle with localStorage persistence
         * âœ… Print-friendly view with clean layout
         * âœ… Search/filter functionality for guests and dishes
         * âœ… Inline editing for name and dish fields
         * âœ… Keyboard shortcuts (Ctrl+N, Escape, ?)
         * âœ… QR code generation with download capability
         * âœ… Notes/dietary info with tooltip display
         * âœ… Missing categories alert system
         * âœ… Offline backup and recovery
         * âœ… View-only mode toggle
         * âœ… CSV export functionality
         * âœ… Table sorting by column (Name, Dish, Category, Serves)
         * âœ… Total servings calculation and display
         * âœ… Responsive design with mobile support
         * âœ… Fall-themed color scheme (amber, orange, warm tones)
         * âœ… Accessibility features (ARIA labels, keyboard navigation)
         * âœ… Input validation (required fields, positive numbers)
         * âœ… SEO optimization with meta tags
         * âœ… Welcome message with usage instructions
         * âœ… Cross-browser compatibility
         * 
         * TECHNICAL STACK:
         * - Vanilla JavaScript (ES6+)
         * - Tailwind CSS via CDN
         * - QRCode.js library
         * - Google Fonts (Inter)
         * - No backend required - pure client-side
         * 
         * LAST UPDATED: November 2025
         */
        
        let guests = [], editingId = null, qrInstance = null;
        let currentEventId = null, isViewMode = false, lastSyncTime = 0, syncInterval = null;
        const categoryIcons = { appetizers: 'ğŸ¥–', mains: 'ğŸ—', sides: 'ğŸ¥—', desserts: 'ğŸ¥§', drinks: 'ğŸ·', other: 'ğŸ´' };
        
        // Dark Mode Toggle
        function toggleDarkMode() {
            document.documentElement.classList.toggle('dark');
            const isDark = document.documentElement.classList.contains('dark');
            localStorage.setItem('darkMode', isDark);
            document.getElementById('darkModeIcon').textContent = isDark ? 'â˜€ï¸' : 'ğŸŒ™';
        }
        
        // Load dark mode preference
        function loadDarkMode() {
            const isDark = localStorage.getItem('darkMode') === 'true';
            if (isDark) {
                document.documentElement.classList.add('dark');
                document.getElementById('darkModeIcon').textContent = 'â˜€ï¸';
            }
        }
        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'n') { e.preventDefault(); showAddModal(); }
            if (e.key === 'Escape') { hideModal(); hideQR(); hideShortcuts(); }
            if (e.key === '?' && !e.target.matches('input, textarea')) { e.preventDefault(); showShortcuts(); }
        });
        function showShortcuts() { document.getElementById('shortcutsModal').classList.remove('hidden'); }
        function hideShortcuts() { document.getElementById('shortcutsModal').classList.add('hidden'); }
        // URL Hash-Based Data Management
        function getUrlParams() {
            const hash = window.location.hash.slice(1);
            const params = {};
            hash.split('&').forEach(part => {
                const [key, value] = part.split('=');
                if (key) params[key] = value;
            });
            return params;
        }
        
        function loadData() {
            const params = getUrlParams();
            
            // Check for event ID
            if (params.event) {
                currentEventId = params.event;
                document.getElementById('liveIndicator').classList.remove('hidden');
                document.getElementById('viewModeBtn').classList.remove('hidden');
                
                // Check view mode
                isViewMode = params.mode === 'view';
                updateViewMode();
                
                // Load from URL data parameter
                if (params.data) {
                    try {
                        const decoded = JSON.parse(atob(params.data));
                        guests = decoded.guests || [];
                        lastSyncTime = Date.now();
                    } catch (e) {
                        console.error('Failed to parse URL data');
                    }
                } else {
                    // Try localStorage for this event
                    const stored = localStorage.getItem(`event_${currentEventId}`);
                    if (stored) guests = JSON.parse(stored);
                }
                
                // Start auto-sync
                startAutoSync();
            } else {
                // No event in URL - check for offline backups
                const lastEventId = localStorage.getItem('lastEventId');
                const legacyStored = localStorage.getItem('thanksgivingGuests');
                
                // If we have a recent offline backup, offer to load it
                if (lastEventId && !legacyStored) {
                    setTimeout(() => loadOfflineCopy(), 500);
                } else if (legacyStored) {
                    // Legacy mode - use localStorage
                    guests = JSON.parse(legacyStored);
                }
            }
            
            loadDarkMode();
            render();
        }
        
        function saveData() {
            if (isViewMode) {
                showToast('ğŸ”’ View-only mode. Cannot edit.', 'warning');
                return false;
            }
            
            if (currentEventId) {
                // Save to localStorage as backup
                localStorage.setItem(`event_${currentEventId}`, JSON.stringify(guests));
                
                // Update URL hash with data
                const data = { guests, updated: Date.now() };
                const encoded = btoa(JSON.stringify(data));
                const mode = isViewMode ? 'view' : 'edit';
                window.location.hash = `event=${currentEventId}&mode=${mode}&data=${encoded}`;
                lastSyncTime = Date.now();
            } else {
                // Legacy localStorage
                localStorage.setItem('thanksgivingGuests', JSON.stringify(guests));
            }
            return true;
        }
        
        // Auto-sync from URL changes
        function startAutoSync() {
            if (syncInterval) clearInterval(syncInterval);
            syncInterval = setInterval(() => {
                const params = getUrlParams();
                if (params.data) {
                    try {
                        const decoded = JSON.parse(atob(params.data));
                        const urlUpdateTime = decoded.updated || 0;
                        
                        // Check if URL was updated by someone else
                        if (urlUpdateTime > lastSyncTime + 2000) {
                            guests = decoded.guests || [];
                            lastSyncTime = Date.now();
                            render();
                            showToast('List updated by another user ğŸ”„', 'info');
                        }
                    } catch (e) {
                        // Ignore parse errors
                    }
                }
            }, 2000);
        }
        
        // Share Link Function
        function shareLink() {
            if (!currentEventId) {
                // Create new event if none exists
                createNewEvent();
                return;
            }
            
            const data = { guests, updated: Date.now() };
            const encoded = btoa(JSON.stringify(data));
            const mode = 'edit';
            const url = `${window.location.origin}${window.location.pathname}#event=${currentEventId}&mode=${mode}&data=${encoded}`;
            
            navigator.clipboard.writeText(url).then(() => {
                showToast('Link copied! Anyone can view and edit âœ…', 'success');
            }).catch(() => {
                showToast('Failed to copy link', 'error');
            });
        }
        
        // Create New Event
        function createNewEvent() {
            const newEventId = Date.now().toString();
            currentEventId = newEventId;
            guests = [];
            const mode = 'edit';
            window.location.hash = `event=${newEventId}&mode=${mode}`;
            document.getElementById('liveIndicator').classList.remove('hidden');
            document.getElementById('viewModeBtn').classList.remove('hidden');
            startAutoSync();
            render();
            showToast('New event created! Share the link to collaborate ğŸ‰', 'success');
        }
        
        // Save Offline Copy
        function saveOfflineCopy() {
            if (currentEventId) {
                // Save current event to localStorage
                localStorage.setItem(`event_${currentEventId}`, JSON.stringify(guests));
                localStorage.setItem('lastEventId', currentEventId);
                showToast('ğŸ’¾ Offline backup saved! Data accessible without internet âœ…', 'success');
            } else {
                // Save to legacy localStorage
                localStorage.setItem('thanksgivingGuests', JSON.stringify(guests));
                showToast('ğŸ’¾ Saved to local storage âœ…', 'success');
            }
        }
        
        // Load Offline Copy
        function loadOfflineCopy() {
            const lastEventId = localStorage.getItem('lastEventId');
            if (lastEventId && confirm('Load your last saved offline event?')) {
                const stored = localStorage.getItem(`event_${lastEventId}`);
                if (stored) {
                    guests = JSON.parse(stored);
                    currentEventId = lastEventId;
                    const mode = 'edit';
                    window.location.hash = `event=${lastEventId}&mode=${mode}`;
                    document.getElementById('liveIndicator').classList.remove('hidden');
                    document.getElementById('viewModeBtn').classList.remove('hidden');
                    startAutoSync();
                    render();
                    showToast('Offline backup loaded! ğŸ’¾', 'success');
                }
            }
        }
        
        // Toggle View Mode
        function toggleViewMode() {
            if (!currentEventId) return;
            isViewMode = !isViewMode;
            updateViewMode();
            
            // Update URL
            const params = getUrlParams();
            const mode = isViewMode ? 'view' : 'edit';
            const data = params.data || '';
            window.location.hash = `event=${currentEventId}&mode=${mode}${data ? '&data=' + data : ''}`;
        }
        
        function updateViewMode() {
            const btn = document.getElementById('viewModeBtn');
            const addBtn = document.querySelector('button[onclick="showAddModal()"]');
            
            if (isViewMode) {
                btn.innerHTML = 'ğŸ”’ View Only';
                btn.classList.remove('bg-amber-500/20', 'border-amber-500', 'text-amber-700', 'dark:text-amber-300');
                btn.classList.add('bg-red-500/20', 'border-red-500', 'text-red-700', 'dark:text-red-300');
                // Hide edit buttons
                document.querySelectorAll('.no-print button').forEach(b => {
                    if (b.id !== 'viewModeBtn' && b.id !== 'darkModeBtn') b.style.display = 'none';
                });
            } else {
                btn.innerHTML = 'âœï¸ Edit Mode';
                btn.classList.remove('bg-red-500/20', 'border-red-500', 'text-red-700', 'dark:text-red-300');
                btn.classList.add('bg-amber-500/20', 'border-amber-500', 'text-amber-700', 'dark:text-amber-300');
                // Show edit buttons
                document.querySelectorAll('.no-print button').forEach(b => b.style.display = '');
            }
        }
        function showAddModal() { editingId = null; document.getElementById('modalTitle').textContent = 'Add Guest'; document.getElementById('addModal').classList.remove('hidden'); document.querySelector('form').reset(); }
        function hideModal() { document.getElementById('addModal').classList.add('hidden'); }
        function saveGuest(e) {
            e.preventDefault();
            const name = document.getElementById('guestName').value.trim();
            const dish = document.getElementById('guestDish').value.trim();
            const category = document.getElementById('guestCategory').value;
            const serves = document.getElementById('guestServes').value;
            const notes = document.getElementById('guestNotes').value.trim();
            if (isViewMode) {
                showToast('ğŸ”’ View-only mode. Cannot edit.', 'warning');
                return;
            }
            if (editingId) {
                const guest = guests.find(g => g.id === editingId);
                Object.assign(guest, {name, dish, category, serves: serves ? parseInt(serves) : null, notes});
                showToast('Guest updated! âœ…', 'success');
            } else {
                guests.push({ id: Date.now().toString(), name, dish, category, serves: serves ? parseInt(serves) : null, notes, emoji: ['ğŸˆ','ğŸ•','ğŸ¥—','ğŸ¥¤','ğŸ‰'][Math.floor(Math.random()*5)] });
                showToast(`${name} added! ğŸ‰`, 'success');
            }
            if (saveData()) { render(); hideModal(); }
        }
        function startEdit(id, field) {
            const guest = guests.find(g => g.id === id);
            const value = guest[field];
            const cell = event.target;
            cell.innerHTML = `<input type="text" value="${value}" class="px-2 py-1 border-2 rounded" onblur="saveEdit('${id}', '${field}', this.value)" onkeydown="if(event.key==='Enter') this.blur(); if(event.key==='Escape') render();" autofocus>`;
            cell.querySelector('input').select();
        }
        function saveEdit(id, field, newValue) {
            if (isViewMode) {
                showToast('ğŸ”’ View-only mode. Cannot edit.', 'warning');
                render();
                return;
            }
            const guest = guests.find(g => g.id === id);
            guest[field] = newValue;
            if (saveData()) {
                render();
                showToast(`${field} updated!`, 'success');
            }
        }
        function editGuest(id) {
            const guest = guests.find(g => g.id === id);
            editingId = id;
            document.getElementById('modalTitle').textContent = 'Edit Guest';
            document.getElementById('guestName').value = guest.name;
            document.getElementById('guestDish').value = guest.dish;
            document.getElementById('guestCategory').value = guest.category || 'other';
            document.getElementById('guestServes').value = guest.serves || '';
            document.getElementById('guestNotes').value = guest.notes || '';
            document.getElementById('addModal').classList.remove('hidden');
        }
        function deleteGuest(id) {
            if (isViewMode) {
                showToast('ğŸ”’ View-only mode. Cannot edit.', 'warning');
                return;
            }
            if (confirm('Remove this guest?')) {
                guests = guests.filter(g => g.id !== id);
                if (saveData()) {
                    render();
                    showToast('Guest removed', 'info');
                }
            }
        }
        function filterGuests() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const clearBtn = document.getElementById('clearBtn');
            const resultsEl = document.getElementById('searchResults');
            if (search) {
                clearBtn.classList.remove('hidden');
                const filtered = guests.filter(g => g.name.toLowerCase().includes(search) || g.dish.toLowerCase().includes(search));
                resultsEl.textContent = `${filtered.length} result${filtered.length !== 1 ? 's' : ''} found`;
                resultsEl.classList.remove('hidden');
                renderGuests(filtered);
            } else { clearBtn.classList.add('hidden'); resultsEl.classList.add('hidden'); render(); }
        }
        function clearSearch() { document.getElementById('searchInput').value = ''; filterGuests(); }
        function updateDashboard() {
            document.getElementById('totalGuests').textContent = guests.length;
            document.getElementById('totalDishes').textContent = guests.length;
            const categories = {};
            guests.forEach(g => { categories[g.category] = (categories[g.category] || 0) + 1; });
            const breakdown = Object.entries(categories).map(([cat, count]) => `${categoryIcons[cat]} ${count}`).join(' â€¢ ');
            document.getElementById('categoryBreakdown').textContent = breakdown || 'No categories yet';
            
            // Check for missing important categories
            const missingAlert = document.getElementById('missingAlert');
            const missingText = document.getElementById('missingText');
            const missing = [];
            if (!categories.mains && guests.length > 0) missing.push('ğŸ— Main Courses');
            if (!categories.desserts && guests.length > 0) missing.push('ğŸ¥§ Desserts');
            
            if (missing.length > 0) {
                missingText.textContent = `We're missing: ${missing.join(', ')}`;
                missingAlert.classList.remove('hidden');
            } else {
                missingAlert.classList.add('hidden');
            }
            
            // Update print date
            document.getElementById('printDate').textContent = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
        }
        function renderGuests(guestList = guests) {
            const tbody = document.getElementById('guestsList');
            const empty = document.getElementById('emptyState');
            if (guestList.length === 0) { tbody.innerHTML = ''; empty.classList.remove('hidden'); return; }
            empty.classList.add('hidden');
            tbody.innerHTML = guestList.map(g => `
                <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                    <td class="px-4 py-3 text-2xl">${g.emoji}</td>
                    <td class="px-4 py-3 editable dark:text-gray-200" onclick="startEdit('${g.id}', 'name')">${g.name}</td>
                    <td class="px-4 py-3 editable dark:text-gray-200" onclick="startEdit('${g.id}', 'dish')">${g.dish}</td>
                    <td class="px-4 py-3"><span class="category-${g.category} px-3 py-1 rounded-full text-xs font-semibold">${categoryIcons[g.category]} ${g.category}</span></td>
                    <td class="px-4 py-3 dark:text-gray-300">${g.serves || 'Not specified'}</td>
                    <td class="px-4 py-3">${g.notes ? `<div class="tooltip"><span class="text-xl">â„¹ï¸</span><span class="tooltiptext">${g.notes}</span></div>` : '<span class="dark:text-gray-400">-</span>'}</td>
                    <td class="px-4 py-3 text-right no-print"><button onclick="editGuest('${g.id}')" class="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 mr-2">Edit</button><button onclick="deleteGuest('${g.id}')" class="text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300">Delete</button></td>
                </tr>
            `).join('');
        }
        // Table Sorting
        let sortColumn = null;
        let sortDirection = 'asc';
        
        function sortTable(column) {
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'asc';
            }
            
            guests.sort((a, b) => {
                let aVal = a[column];
                let bVal = b[column];
                
                // Handle serves as number
                if (column === 'serves') {
                    aVal = aVal || 0;
                    bVal = bVal || 0;
                    return sortDirection === 'asc' ? aVal - bVal : bVal - aVal;
                }
                
                // Handle strings
                aVal = (aVal || '').toString().toLowerCase();
                bVal = (bVal || '').toString().toLowerCase();
                
                if (sortDirection === 'asc') {
                    return aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
                } else {
                    return aVal > bVal ? -1 : aVal < bVal ? 1 : 0;
                }
            });
            
            render();
            showToast(`Sorted by ${column} (${sortDirection === 'asc' ? 'ascending' : 'descending'})`, 'info');
        }
        
        function render() {
            renderGuests();
            updateDashboard();
            
            // Calculate and display total servings
            const totalServings = guests.reduce((sum, g) => sum + (g.serves || 0), 0);
            const servingsDisplay = document.getElementById('totalServingsDisplay');
            const servingsValue = document.getElementById('totalServings');
            
            if (totalServings > 0) {
                servingsValue.textContent = totalServings;
                servingsDisplay.classList.remove('hidden');
            } else {
                servingsDisplay.classList.add('hidden');
            }
            
            // Show info banner if in offline mode (no event ID)
            const infoBanner = document.getElementById('infoBanner');
            if (!currentEventId && guests.length > 0) {
                infoBanner.classList.remove('hidden');
            } else {
                infoBanner.classList.add('hidden');
            }
        }
        function showQR() {
            let url = window.location.href;
            
            // If we have an event, generate URL with current data
            if (currentEventId) {
                const data = { guests, updated: Date.now() };
                const encoded = btoa(JSON.stringify(data));
                const mode = 'edit';
                url = `${window.location.origin}${window.location.pathname}#event=${currentEventId}&mode=${mode}&data=${encoded}`;
            }
            
            document.getElementById('qrModal').classList.remove('hidden');
            const qrDiv = document.getElementById('qrcode');
            qrDiv.innerHTML = '';
            qrInstance = new QRCode(qrDiv, { text: url, width: 256, height: 256, colorDark: "#000000", colorLight: "#ffffff" });
        }
        function hideQR() { document.getElementById('qrModal').classList.add('hidden'); }
        function downloadQR() {
            const canvas = document.querySelector('#qrcode canvas');
            const url = canvas.toDataURL('image/png');
            const a = document.createElement('a');
            a.href = url;
            a.download = 'thanksgiving-potluck-qr.png';
            a.click();
            showToast('QR Code downloaded! ğŸ“¥', 'success');
        }
        function exportCSV() {
            const csv = [['Name', 'Dish', 'Category', 'Serves', 'Notes'], ...guests.map(g => [g.name, g.dish, g.category, g.serves || '', g.notes || ''])].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `thanksgiving-potluck-${Date.now()}.csv`;
            a.click();
            showToast('CSV exported! ğŸ“„', 'success');
        }
        function showToast(msg, type = 'info') {
            const colors = { success: 'bg-green-500', error: 'bg-red-500', warning: 'bg-yellow-500', info: 'bg-blue-500' };
            const toast = document.createElement('div');
            toast.className = `${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg mb-2`;
            toast.textContent = msg;
            document.getElementById('toastContainer').appendChild(toast);
            setTimeout(() => { toast.style.opacity = '0'; toast.style.transition = 'opacity 0.3s'; setTimeout(() => toast.remove(), 300); }, 3000);
        }
        window.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>
